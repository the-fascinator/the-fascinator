function anotarFactory(a,b){function f(a){return"."+g(a)}function g(a){return b.stylePrefix+a}function n(a){switch(a.toLowerCase()){case"seealso":a="http://www.w3.org/2000/10/annotationType#SeeAlso";break;case"question":a="http://www.w3.org/2000/10/annotationType#Question";break;case"explanation":a="http://www.w3.org/2000/10/annotationType#Explanation";break;case"example":a="http://www.w3.org/2000/10/annotationType#Example";break;case"comment":a="http://www.w3.org/2000/10/annotationType#Comment";break;case"change":a="http://www.w3.org/2000/10/annotationType#Change";break;case"advice":a="http://www.w3.org/2000/10/annotationType#Advice";break;case"tag":a="http://www.purl.org/anotar/ns/type/0.1#Tag";break;case"highlight":a="http://www.purl.org/anotar/ns/type/0.1#Highlight";break;default:break}b.annoType=a}function o(){var a=[];l.find(b.tagList).each(function(b,c){if(c.innerHTML!="")a.push(c)});return a}function p(a){if(!p.crcs)p.crcs={};var c,d;if(!a.attr(b.hashAttr)){d=a.text();d=d.replace(/\s+/g," ");c=Crc32(d).toLowerCase();if(p.crcs[c]){p.crcs[c].push(true);d=p.crcs[c].length}else{p.crcs[c]=[true];d=1}a.attr(b.hashAttr,"h"+c+"p"+d)}}function q(b){a.each(b,function(b,c){p(a(c))})}function r(c){if(!r.interfaceSpan){if(b.replyLabel&&!b.disableReply){var e=G(b.replyLabel,{style:b.stylePrefix});var h={style:b.stylePrefix,label:e};r.replySpan=a(G(m.commandText,h))}h={style:b.stylePrefix,label:b.interfaceLabel};r.interfaceSpan=a(G(m.commandText,h))}var i=b.interfacePrepend;var j=r.interfaceSpan;var k=b.interfaceVisible;if(c.hasClass(g("inline-annotation"))){i=true;j=r.replySpan;k=true}var l=function(a){if(i){a.prepend(j)}else{if(a.children(f("has-annotation")).size()!=0){a.children(f("has-annotation")).before(j)}else{a.append(j)}}j.unbind();j.mousedown(function(a){return false});j.mouseup(n)};var n=function(c){var e=a(c.target).closest("["+b.hashAttr+"]");if(e.size()>0){d.annotate(e)}if(!b.interfaceVisible)o();return false};var o=function(){j.remove()};if(k){var p=j.clone();p.mousedown(function(a){return false});p.mouseup(n);if(i){c.prepend(p)}else{c.append(p)}}else{c.hover(function(a){l(c)},function(a){o()});c.mousedown(function(a){o()})}}function t(b){a.each(b,function(b,c){var d=a(c);if(d.find(".anno-command").size()===0){r(d)}})}function u(){function c(c,d){if(!c){alert("Error in Load Annotations: No Data.");return}var e;try{e=JSON.parse(c);a.each(e,function(a,c){b.loadAnnotation(c)})}catch(f){alert("JSON ERROR: "+f)}}if(b.pageUri){x(b.pageUri,c)}else{a.each(k,function(a,d){var e=$(d).attr(b.uriAttr);x(e,c)})}}function v(c){function k(c){if(b.collapseComments){var d,e;d=c.find(f("inline-annotation")).size();e=c.find(f("showHideComments"));if(e.size()===0){e=a(G(m.showHideButton,{style:b.stylePrefix,count:d}));c.prepend(e);function g(b){var c,d;d=a(b.target).closest(f("showHideComments"));c=d.parent().find(f("commentList"));if(c.is(":visible")){c.hide();d.find(f("showHideText")).html("View")}else{c.show();d.find(f("showHideText")).html("Hide")}return false}b.showHideFunction=b.showHideFunction||g;e.click(b.showHideFunction);e.click()}else{e.find(f("annotationCount")).html(d)}}}var d=c.annotates.uri;var e=c.annotates.locators||[];var h=null;var i,j;var n=function(c,d,e){var h,i,j,n;if(b.outputInChild){c.find(b.outputInChild).append(d)}else{if(e){if(!c.hasClass(g("anno-children"))){c=c.children(f("anno-children"))}c.append(d)}else{h=g("has-annotation");i=c.attr(b.hashAttr);n=l.find("["+b.stylePrefix+"locatorhash='"+i+"']");if(n.size()===0){j=c[0].tagName.toLowerCase();n=a(G(m.commentContainer,{style:b.stylePrefix,hash:i}));n.append(G(m.commentList,{style:b.stylePrefix}));if(b.listElementTagNames.search(j)===-1){c.after(n)}else{c.append(n)}}n.children(f("commentList")).append(d)}}if(!n){n=d.closest(f("has-annotation"))}k(n)};if(b.pageUri){j=c.annotates.uri!=c.annotates.rootUri;if((j||e.length==0||e[0].type!="http://www.purl.org/anotar/locator/0.1")&&c.type!="http://www.purl.org/anotar/ns/type/0.1#Tag"){i=a("*["+b.uriAttr+"='"+d+"']")}else{if(e[0].type==b.hashType){h=e[0].value;i=a("*["+b.hashAttr+"='"+h+"']")}else{return}}}else{i=a("*["+b.uriAttr+"='"+d+"']")}var o="odd";if(i.hasClass("odd"))o="even";var q=D(c,o);if(!b.disableReply)r(q,true);p(q);if(i.size()!==0){n(i,q,j);if(c.replies){a.each(c.replies,function(a,c){b.loadAnnotation(c)})}}else{var s=b.stylePrefix+"orphans";var t=m.orphanHolder;if(b.orphanHolder!=null&&b.orphanHolderId!=null){s=b.orphanHolderId;t=b.orphanHolder}var u=l.find("#"+s);if(u.size()==0){l.append(G(t,{style:b.stylePrefix}));u=l.find("#"+s)}u.append(q)}return q}function w(a,c){var d="";var e="";var f;d="_design/anotar/_view/id?key=";e=escape('"'+a+'"');f=b.serverAddress+d+e;z(f,"GET",null,c)}function x(a,c){var d="";var e="";var f;d="_design/anotar/_list/nested/all?key=";e=escape('"'+a+'"');f=b.serverAddress+d+e;z(f,"GET",null,c)}function y(a,b,c){z(a,"POST",b,c)}function z(a,c,d,e){var f=function(b,d){h="";try{e(b,d)}catch(f){alert("Error in callback: "+f+", requestURL: "+a+", method :"+c);return}};var g=function(a,b,c){h="ERROR (STATUS: '"+b+"', CODE: '"+a.responseCode+"', BODY: '"+a.responseText+"')";alert(h)};if(c=="GET")b.getHttpData(a,f,g);else if(c=="POST")b.postHttpData(a,d,f,g)}function A(b,c,d){a.ajax({type:"GET",url:b,success:c,error:d,dataType:"text"})}function B(b,c,d,e){a.ajax({type:"POST",url:b,success:d,error:e,dataType:"text",data:c})}function C(a){var c=a.annotates.uri;var d=function(a,c){if(!a)return;var d=JSON.parse(a);if(d.ok==true){var e=function(a,c){var d=JSON.parse(a).rows[0].value;var e=b.loadAnnotation(d);e=e.closest(f("has-annotation"));if(!e.find(f("commentList")).is(":visible")){e.find(f("showHideComments")).click()}};w(d.id,e)}else if(d.annotates){var g=b.loadAnnotation(d);g=g.closest(f("has-annotation"));if(!g.find(f("commentList")).is(":visible")){g.find(f("showHideComments")).click()}}else{alert("Sorry! An error occurred saving that data!")}};var e=JSON.stringify(a);y(b.serverAddress,e,d)}function D(b,c){var d=a(E(b,c));if(a.timeago)d.find(".timeago").timeago();return d}function E(a,c){function h(a){a=a.replace(/\&/g,"&");a=a.replace(/\</g,"<");a=a.replace(/\>/g,">");a=a.replace(/\'/g,"&#39;");a=a.replace(/\"/g,""");a=a.replace(/\n/g,"<br />");a=a.replace(/\r/g,"<br />");a=unescape(a);return a}var d="Anonymous";var e=function(a){switch(a){case"http://www.purl.org/anotar/ns/type/0.1#Tag":return m.tagDisplay;case"http://www.purl.org/anotar/ns/type/0.1#Highlight":return m.highlightDisplay;case"http://www.w3.org/2000/10/annotationType#SeeAlso":case"http://www.w3.org/2000/10/annotationType#Question":case"http://www.w3.org/2000/10/annotationType#Explanation":case"http://www.w3.org/2000/10/annotationType#Example":case"http://www.w3.org/2000/10/annotationType#Change":case"http://www.w3.org/2000/10/annotationType#Advice":case"http://www.w3.org/2000/10/annotationType#Comment":default:return m.commentDisplay}};if(a.creator.literal!=null){d=a.creator.literal}if(a.annotates.locators&&a.annotates.locators.length>0)var f=a.annotates.locators[0].originalContent;if(f==undefined)f="";var g="";var i={style:b.stylePrefix,toggle:c,id:a.uri,root:a.annotates.rootUri,original:h(f),creator:d,date:a.dateCreated.literal,content:h(a.content.literal),children:g,tagCount:a.tagCount,locator:null,contentUri:a.contentUri};if(a.annotates.locators&&a.annotates.locators.length>0){i.locator=a.annotates.locators[0].value}var j=null;if(b.displayCustom!=null){j=b.displayCustom}else{j=e(a.type)}return G(j,i)}function F(){var a=new Date;var b=function(a){s=a.toString();if(s.length==1)s="0"+s;return s};var c=function(){tz=a.getTimezoneOffset()*60/-36;tz=tz.toString();var b=false;if(tz[0]=="-")b=true;while(tz.length<4)tz="0"+tz;if(b){tz="-"+tz}else{tz="+"+tz}tz=tz.substring(0,3)+":"+tz.substring(3);return tz};var d=""+a.getFullYear()+"-"+b(a.getMonth()+1)+"-"+b(a.getDate())+"T"+b(a.getHours())+":"+b(a.getMinutes())+":"+b(a.getSeconds())+c();return d}function G(a,b){var c=!/\W/.test(a)?i[a]=i[a]||G(document.getElementById(a).innerHTML):new Function("obj","var p=[];"+"with(obj) {p.push('"+a.replace(/[\r\t\n]/g," ").replace(/'/g,"\r").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');} return p.join('');");return b?c(b):c}function H(b){function q(){var f={style:j,label:b.label};if(b.formCustom==null){c=G(m.annotateForm,f)}else{c=G(b.formCustom,f)}c=a(c);d=a(G(m.annotateTitle,f));e=c.find(b.contentInput);b.formCancel=b.formCancel||"button."+j+"cancel";b.formSubmit=b.formSubmit||"button."+j+"submit";b.formClear=b.formClear||"button."+j+"clear";b.formClose=b.formClose||"button."+j+"close";b.formCancelFunction=b.formCancelFunction||u;b.formClearFunction=b.formClearFunction||v;b.formCloseFunction=b.formCloseFunction||t;b.formSubmitFunction=b.formSubmitFunction||w}function r(a){var c={};c.clientVersionUri=b.clientUri;c.type=b.annoType;c.title={literal:a.title,uri:null};c.annotates={literal:b.objectLiteral,uri:a.uri,rootUri:a.root};c.annotates.locators=[];if(a.hash){var d={originalContent:a.originalContent,type:b.hashType,value:a.hash};c.annotates.locators.push(d)}c.creator={literal:b.creator,uri:b.creatorUri,website:b.creatorWebsite,email:{literal:b.creatorEmail}};c.dateCreated={literal:F(),uri:null};c.dateModified={literal:null,uri:null};c.content={mimeType:"text/plain",literal:a.content,formData:{}};if(a.contentUri){c.contentUri=a.contentUri}c.isPrivate=false;if(a.isPrivate)c.isPrivate=a.isPrivate;c.lang=b.lang;return c}function s(){if(i!=null){c.remove();d.remove();if(i.parent().hasClass(g("inline-annotation-quote"))){i.parent().parent().replaceWith(i)}i=null}}function t(){s();h[p]=a.trim(e.val())}function u(){e.val(h[p]);b.formCloseFunction()}function v(){e.val("")}function w(d){var g,i,j,m,n;var q,t,u,v,w,x;t=a(d.target);h[p]="";g=a.trim(e.val());if(g=="")return;x=t.closest(f("inline-annotation-form"));u=x.find(f("inline-annotation-quote>*"));if(u.children(f("has-annotation")).size()!==0){v=u.children(f("has-annotation"));u.parent().append(v)}n=u.text();if(q)u.append(q);if(v)u.append(v);w=false;if(b.usePrivacy){w=x.find(f(b.privacyClassName)+":checked").val()=="true"}i=t.wrap("<div/>").parent().html();i=a(i).text();t.parent().replaceWith(t);hashValue=p;if(!b.pageUri){hashValue=$(k[0]).attr(b.hashAttr)}else if(b.hashFunction){hashValue=b.hashFunction(l)}data={uri:o,root:b.pageUri||o,hash:hashValue,originalContent:n,content:g,isPrivate:w};if(b.getContentUri){json=b.getContentUri($(b.docRoot));if(json.isUri){data.contentUri=json.contentUri}}s();data=r(data);b.submitAnnotation(data,c)}function y(a){function g(){a.wrap(G(m.annotateWrap,f));if(b.formPrepend){a.parent().prepend(c)}else{a.parent().append(c)}a.parent().prepend(d);a.wrap(G(m.annotateQuote,f))}var f={style:j};if(i!=null){s();b.formCancelFunction()}p=a.attr(b.hashAttr);if(b.uriAttr){o=a.attr(b.uriAttr);if(b.pageUri){if(o){pageUriPos=o.search(b.pageUri);if(pageUriPos==-1)pageUriPos=0;if(o.substring(pageUriPos,b.pageUri.length+pageUriPos)===b.pageUri){p=null}else{o=b.pageUri}}else{o=b.pageUri}}}x();if(b.formPopup){if(!b.formPopupSettings)b.formPopupSettings={closeText:"x",resizable:false,title:"Anotar"};try{c.dialog(b.formPopupSettings)}catch(h){g()}}else{g()}if(b.onFormDisplay){b.onFormDisplay(e)}c.find(b.formClear).click(b.formClearFunction);c.find(b.formCancel).click(b.formCancelFunction);c.find(b.formClose).click(b.formCloseFunction);c.find(b.formSubmit).click(b.formSubmitFunction);i=a;e.focus()}var c,d,e;var h={};var i=null;var j=b.stylePrefix;var n={};var o,p;var x=function(){if(p in h){e.val(h[p])}else{e.val("")}};q();n.annotate=y;return n}var c={};if(!b)b={};b.docRoot=b.docRoot||"#anno-root";b.tagList=b.tagList||"p, h1, h2, h3, h4, h5, h6";b.listElementTagNames=b.listElementTagNames||"li,lh,dd,dt";b.label=b.label||"Comment on this:";b.lang=b.lang||"en";b.creatorUri=b.creatorUri||"http://www.purl.org/anotar/ns/user/0.1#Anonymous";b.clientUri=b.clientUri||"http://www.purl.org/anotar/client/0.1";b.stylePrefix=b.stylePrefix||"anno-";b.interfaceLabel=b.interfaceLabel||" &#xb6;";b.interfaceVisible=b.interfaceVisible||false;b.replyLabel=b.replyLabel||"[reply]";b.contentInput=b.contentInput||"textArea";b.getContentUri=b.getContentUri||null;b.hashAttr=b.hashAttr||"anotar-hash";b.hashType=b.hashType||"http://www.purl.org/anotar/locator/0.1";b.hashFunction=b.hashFunction||null;b.uriAttr=b.uriAttr||"id";b.disableReply=b.disableReply||false;b.setPageUriOnLoad=b.setPageUriOnLoad||false;b.submitAnnotation=b.submitAnnotation||C;b.loadAnnotation=b.loadAnnotation||v;b.loadAnnotations=b.loadAnnotations||u;b.getHttpData=b.getHttpData||A;b.postHttpData=b.postHttpData||B;annotationType=b.annotationType||"comment";n(annotationType);c.config=b;if(b.docRoot.length==0)e.die("No document root ("+b.docRoot+") found!");var d;var e;if(b.debug){e={die:function(a){alert("DEBUG: "+a)}}}else{e={die:function(a){}}}var h="";var i={};var j="http://www.purl.org/anotar/ns/user/0.1#Anonymous";var k=[];var l=a(b.docRoot);var m={commandText:"<span class='<%=style%>command'><%=label%></span>",annotateForm:"<div class='<%=style%>annotate-form'>"+"<div class='<%=style%>annotate-form-elements'>"+"<textarea class='<%=style%>annotate-text'></textarea><br/>"+"<button class='<%=style%>cancel'>Cancel</button> "+"<button class='<%=style%>submit'>Submit</button> "+"</div>"+"<span class='<%=style%>info'></span>"+"</div>",annotateTitle:"<div class='<%=style%>app-label'><%=label%></div>",annotateWrap:"<div class='<%=style%>inline-annotation-form'/>",annotateQuote:"<blockquote class='<%=style%>inline-annotation-quote'/>",replyButton:"<button class='<%=style%>reply'>Reply</button>",commentDisplay:"<div class='<%=style%>inline-annotation <%=toggle%>' id='<%=id%>'>"+"<input name='rootUri' value='<%=root%>' type='hidden'/>"+"<div class='<%=style%>orig-content' style='display:none;'><%=original%></div>"+"<div class='<%=style%>anno-info'>"+"Comment by: <span class='<%=style%>anno-creator'><%=creator%></span>"+"   <span class='<%=style%>anno-date timeago' title='<%=date%>'><%=date%></span>"+"</div>"+"<div class='<%=style%>anno-content'><%=content%></div>"+"<div class='<%=style%>anno-children'><%=children%></div>"+"</div>",showHideButton:"<a href='' class='<%=style%>showHideComments'>[<span class='<%=style%>showHideText' /> "+"<span class='<%=style%>annotationCount'><%=count%></span> comment(s)...]</a>",commentContainer:"<div class='<%=style%>has-annotation' <%=style%>locatorhash='<%=hash%>' />",commentList:"<div class='<%=style%>commentList'></div>",seeAlsoDisplay:"",questionDisplay:"",explanationDisplay:"",exampleDisplay:"",changeDisplay:"",adviceDisplay:"",tagDisplay:"<span class='<%=style%>tag'><%=content%><% if(tagCount > 1){ %> (<%=tagCount%>)<% } %></span>",highlightDisplay:"",orphanHolder:"<p id='<%=style%>orphans'>Below are annotations that we can no longer attach to this document reliably because the data has changed.</p>"};if(!b.pageUri&&b.setPageUriOnLoad)b.pageUri=window.location.href.split("#",1)[0];k=o();d=H(b);q(k);t(k);b.loadAnnotations();c.setType=n;return c}function Crc32(a){function b(a){return d(c(a))}function c(a){var b=a.length;var c=4294967295;for(var d=0;d<b;d++){c=f(c,a.charCodeAt(d))}return c^4294967295}function d(a){var b;var c;var d;b=a&65535;c=b.toString(16).toUpperCase();while(c.length<4){c="0"+c}b=a>>>16&65535;d=b.toString(16).toUpperCase();while(d.length<4){d="0"+d}return d+c}function f(a,b){return e[(a^b)&255]^a>>8&16777215}var e=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117];return b(a)}